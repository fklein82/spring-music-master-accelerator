accelerator:
  displayName: AB Spring Music
  description: Tanzu Application Platform Accelerator to spin up a new service for the Spring Music app
  iconUrl: https://raw.githubusercontent.com/fklein82/spring-music-master-accelerator/main/music-icons.png
  tags:
    - java
    - spring
    - springmusic
  options:
    - label: Workload Namespace
      description:  The namespace where the application services will be deployed.  This field is needed for properly creating resource claims.
      defaultValue: dev
      name: workloadNamespace
      inputType: text
      dataType: string
      required: true
    - label: Database Type
      description: The type of database that services will connect to.
      inputType: select
      defaultValue: h2
      name: dbType
      choices:
        - value: Postgresql
          text: PostgreSQL (from VMware Application Catalog)
        - value: h2
          text: H2 (In Memory DB)
      required: true
    - label: Create Resource Claim Defintion for Services
      description: "If set to true, a resource claim definition yaml file for the data services will be created."
      defaultValue: true
      name: createResourceClaim
      inputType: checkbox
      dataType: boolean
      required: true
      hidden: true
engine:
  merge:
  - include: [ "**" ]
  - include: ["**/templates/workloads.template"]
    chain:
    - type: YTT
#    - type: ReplaceText
#      substitutions:
#        - text: "_NAMESPACE_"
#          with: "#workloadNamespace"  
    - type: RewritePath
      regex: 'templates/workloads.template'
      rewriteTo: "'config/workloads-test.yaml'"

  - condition: "#createResourceClaim && ( #dbType == 'Postgresql') " 
    include: ["**/templates/oss-postgresql.yaml"]
    chain:
    - type: ReplaceText
      substitutions:
        - text: "_NAMESPACE_"
          with: "#workloadNamespace" 
    - type: RewritePath
      regex: 'templates/oss-postgresql.yaml'
      rewriteTo: "'config/oss-postgresql-test.yaml'"
